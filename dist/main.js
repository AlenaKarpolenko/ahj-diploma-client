!function(e){var s={};function t(i){if(s[i])return s[i].exports;var a=s[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,t),a.l=!0,a.exports}t.m=e,t.c=s,t.d=function(e,s,i){t.o(e,s)||Object.defineProperty(e,s,{enumerable:!0,get:i})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,s){if(1&s&&(e=t(e)),8&s)return e;if(4&s&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&s&&"string"!=typeof e)for(var a in e)t.d(i,a,function(s){return e[s]}.bind(null,a));return i},t.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(s,"a",s),s},t.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},t.p="",t(t.s=1)}([function(e,s,t){},function(e,s,t){"use strict";t.r(s);t(0);class i{constructor(e){this.server=e,this.wsServer=this.server.replace(/^http/i,"ws"),this.data={event:"load"},this.callbacks={error:()=>{throw Error("Ошибка соединения")}},this.onOpen=this.onOpen.bind(this),this.onMessage=this.onMessage.bind(this)}init(){this.ws=new WebSocket(this.wsServer),this.ws.addEventListener("open",this.onOpen),this.ws.addEventListener("message",this.onMessage),this.ws.addEventListener("error",this.callbacks.error),this.ws.addEventListener("close",this.callbacks.error)}onOpen(){this.ws.send(JSON.stringify(this.data))}onMessage(e){const s=JSON.parse(e.data);"database"===s.event&&(this.callbacks.load(s.dB,s.favourites,s.position),s.pinnedMessage&&this.callbacks.pinMessage(s.pinnedMessage.type,s.pinnedMessage.id,s.pinnedMessage.message,s.pinnedMessage.geo,s.pinnedMessage.date),this.callbacks.sideLoad(s.side)),"text"===s.event&&(this.callbacks.message(s.id,s.message,s.geo,s.date),this.callbacks.sideLoad(s.side)),"file"===s.event&&(this.callbacks.file(s.type,s.id,s.message,s.geo,s.date),this.callbacks.sideLoad(s.side)),"storage"===s.event&&this.callbacks.sideCategory(s),"select"===s.event&&this.callbacks.showMessage(s.message),"delete"===s.event&&(this.callbacks.delete(s.id),this.callbacks.sideLoad(s.side)),"favourite"===s.event&&(this.callbacks.favourite(s.id),this.callbacks.sideLoad(s.side)),"favouriteRemove"===s.event&&(this.callbacks.favouriteRemove(s.id),this.callbacks.sideLoad(s.side)),"favouritesLoad"===s.event&&(this.callbacks.load(s.dB,s.favourites,0),s.pinnedMessage&&this.callbacks.pinMessage(s.pinnedMessage.type,s.pinnedMessage.id,s.pinnedMessage.message,s.pinnedMessage.geo,s.pinnedMessage.date),this.callbacks.sideFavourites(s.dB)),"pin"===s.event&&(this.callbacks.pin(s.pinnedMessage.id),this.callbacks.pinMessage(s.pinnedMessage.type,s.pinnedMessage.id,s.pinnedMessage.message,s.pinnedMessage.geo,s.pinnedMessage.date)),"unpin"===s.event&&this.callbacks.unpin(s.id)}send(e,s){1===this.ws.readyState?(this.data={event:e,message:s},this.ws.send(JSON.stringify(this.data))):this.callbacks.error()}sendFile(e){const s=new XMLHttpRequest;s.open("POST",this.server+"/upload"),s.addEventListener("error",()=>this.callbacks.error()),s.send(e)}}class a{static createMessageContainer(e,s,t){const i=new Intl.DateTimeFormat("ru",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"}),a=document.createElement("div");return a.classList.add("chaos_messages_message"),a.innerHTML=`\n\t\t<div class="chaos_message_header">\n\t\t  <div class="chaos_message_tools"></div>\n\t\t</div>\n\t\t<div class="chaos_message_body">\n\t\t  ${e}\n\t\t</div>`,s&&(a.innerHTML+=`\n\t\t  <div class="chaos_message_geo">\n\t\t\t<div class="chaos_geo_icon"></div>\n\t\t\t<a href="https://yandex.ru/maps/?text=${s}" target="_blank">[${s}]</a>\n\t\t  </div>`),a.innerHTML+=`\n\t\t<div class="chaos_message_date">\n\t\t  ${i.format(t)}\n\t\t</div>`,a}static createMessageElement(e,s,t){const i=`<p>${this.linkify(e)}</p>`;return a.createMessageContainer(i,s,t)}static createImageElement(e,s,t,i){const o=`<img class="chaos_messages_image" src="${e}/${s}">`;return a.createMessageContainer(o,t,i)}static createVideoElement(e,s,t,i){const o=`<video class="chaos_messages_video" src="${e}/${s}" controls></video>`;return a.createMessageContainer(o,t,i)}static createAudioElement(e,s,t,i){const o=`<audio class="chaos_messages_audio" src="${e}/${s}" controls></audio>`;return a.createMessageContainer(o,t,i)}static createFileElement(e,s,t,i){const o=`\n\t\t<div class="chaos_messages_file">\n\t\t  <a href="${e}/${s}">\n\t\t\t<div class="chaos_messages_file_bg"></div>\n\t\t  </a>\n\t\t  <a href="${e}/${s}">${s}</a>\n\t\t</div>`;return a.createMessageContainer(o,t,i)}static createToolsElements(){const e=document.createElement("div");return e.classList.add("chaos_message_tools_container"),e.innerHTML='\n\t\t  <div class="chaos_message_tools_delete"></div>\n\t\t  <div class="chaos_message_tools_pin"></div>\n\t\t  <div class="chaos_message_tools_favourite"></div>\n\t\t',e}static getFavouriteMark(){const e=document.createElement("div");return e.classList.add("chaos_message_favourite"),e}static getPinMark(){const e=document.createElement("div");return e.classList.add("chaos_message_pin"),e}static getPinnedMessage(e){const s=document.createElement("div");return s.classList.add("chaos_pinned"),s.innerHTML=`\n\t\t  <div class="chaos_pinned_side">\n\t\t\t<div class="chaos_pinned_title">Закреплённое сообщение <div class="chaos_pinned_close"></div></div>\n\t\t\t<div class="chaos_pinned_select"></div>\n\t\t  </div>\n\t\t  <div class="chaos_pinned_container">\n\t\t\t${e.innerHTML}\n\t\t  </div>\n\t\t`,s}static createSelectContainer(e){const s=document.createElement("div");s.classList.add("chaos_messages","chaos_select_container");const t=new Intl.DateTimeFormat("ru",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});return s.innerHTML=`\n\t  <div class="chaos_select_header">\n\t\tСообщение от ${t.format(e)}\n\t\t<div class="chaos_select_close"></div>\n\t  </div>`,s}static createErrorConnectionElement(){const e=document.createElement("div");return e.classList.add("chaos_connection_error"),e}static createSideElement(e,s,t){const i=document.createElement("li");return i.classList.add("chaos_side_item",e),i.innerHTML=`${s}: <span>${t}</span>`,i}static createSideSubheadElement(e){const s=document.createElement("div");return s.classList.add("chaos_side_subhead"),s.innerHTML=`<h3>${e}</h3><div class="chaos_side_close"></div>`,s}static createSideCategoryList(){const e=document.createElement("ul");return e.classList.add("chaos_side_list"),e}static createSideElementContainer(e){const s=document.createElement("li");return s.classList.add("chaos_side_item","chaos_side_open_item"),s.innerHTML=`\n\t\t<div class="chaos_side_open_container">\n\t\t  <div class="chaos_side_open_element">\n\t\t\t${e}\n\t\t  </div>\n\t\t  <div class="chaos_side_open_select"></div>\n\t\t</div>\n\t  `,s}static createSideLinkElement(e){const s=`<p><a href="${e}">${e}</a></p>`;return a.createSideElementContainer(s)}static createSideImageElement(e,s){const t=`<img class="chaos_messages_image" src="${s}/${e}">`;return a.createSideElementContainer(t)}static createSideVideoElement(e,s){const t=`<video class="chaos_messages_video" src="${s}/${e}" controls></video>`;return a.createSideElementContainer(t)}static createSideAudioElement(e,s){const t=`<audio class="chaos_messages_audio" src="${s}/${e}" controls></audio>`;return a.createSideElementContainer(t)}static createSideFileElement(e,s){const t=`<p><a href="${s}/${e}">${e}</a></p>`;return a.createSideElementContainer(t)}static createFavouritesDescription(e,s,t){const i=document.createElement("li");i.classList.add("chaos_side_item","chaos_side_open_item");const a=new Intl.DateTimeFormat("ru",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});return i.innerHTML=`\n\t\t<div class="chaos_side_open_container">\n\t\t  <div class="chaos_side_open_element">\n\t\t\t<p class="chaos_side_favourites_description">Кол-во сообщений: <b>${e}</b><br>\n\t\t\tС <b>${a.format(s)}</b><br>\n\t\t\tПо <b>${a.format(t)}</b></p>\n\t\t  </div>\n\t\t</div>\n\t  `,i}static getAddForm(){const e=document.createElement("label");return e.classList.add("chaos_file_label"),e.innerHTML='\n\t\t<div class="chaos_file_input">Прикрепить файл</div>\n\t\t<input type="file" class="chaos_file_hidden">',e}static getMediaForm(e){const s=document.createElement("div");return s.classList.add("chaos_media_container"),s.innerHTML=`\n\t\t<div class="chaos_media_record"></div>\n\t\t<div class="chaos_media_status">\n\t\t  Ожидание ${e}\n\t\t</div>\n\t\t<div class="chaos_media_stop"></div>`,s}static createGeoElement(e){const s=document.createElement("div");return s.classList.add("chaos_geo"),s.innerHTML=`\n\t\t<div class="chaos_geo_icon"></div>\n\t\t[${e}]\n\t\t<div class="chaos_geo_close"></div>\n\t\t`,s}static errorMediaForm(){const e=document.createElement("div");return e.classList.add("chaos_media_container"),e.innerHTML='\n\t\t<div class="chaos_media_status">\n\t\t  Ваш браузер не поддерживает запись медиа\n\t\t</div>',e}static getCloseForm(){const e=document.createElement("div");return e.classList.add("chaos_form_close"),e}static createDropPlace(){const e=document.createElement("div");return e.classList.add("chaos_dropplace_container"),e.innerHTML='<div class="chaos_dropplace"></div>',e}static linkify(e){return e.replace(/((http:\/\/|https:\/\/){1}(www)?([\da-z.-]+)\.([a-z.]{2,6})([/\w.-?%#&-]*)*\/?)/gi,'<a href="$1">$1</a>')}}class o{constructor(e,s,t){this.parentElement=e,this.listElement=this.parentElement.querySelector(".chaos_side_list"),this.messageClass=s,this.request=t,this.render=this.render.bind(this),this.closeCategory=this.closeCategory.bind(this),this.showCategoryItems=this.showCategoryItems.bind(this),this.showFavouritesDescription=this.showFavouritesDescription.bind(this),this.categoryItems={links:{class:"chaos_side_links",text:"Ссылки",handler:a.createSideLinkElement},favourites:{class:"chaos_side_favourites",text:"Избранное",handler:a.createSideFavouriteElement},image:{class:"chaos_side_images",text:"Изображения",handler:a.createSideImageElement},file:{class:"chaos_side_files",text:"Файлы",handler:a.createSideFileElement},video:{class:"chaos_side_videos",text:"Видео",handler:a.createSideVideoElement},audio:{class:"chaos_side_audios",text:"Аудио",handler:a.createSideAudioElement}}}render(e){this.listElement.innerHTML="";for(const s in e){const t=a.createSideElement(this.categoryItems[s].class,this.categoryItems[s].text,e[s]);this.listElement.append(t),e[s]>0&&t.addEventListener("click",()=>this.requestCategoryItems(s))}}requestCategoryItems(e){if("favourites"===e){for(this.category="favourites",this.openCategory(this.categoryItems[e].text);this.messageClass.messagesElement.firstChild;)this.messageClass.messagesElement.removeChild(this.messageClass.messagesElement.firstChild);return this.messageClass.messages.clear(),void this.request.send("favouritesLoad")}this.openCategory(this.categoryItems[e].text),this.request.send("storage",e)}openCategory(e){const s=a.createSideSubheadElement(e),t=s.querySelector(".chaos_side_close");this.listElement.replaceWith(s),t.addEventListener("click",this.closeCategory)}closeCategory(){if(this.parentElement.querySelector(".chaos_side_subhead").remove(),this.parentElement.querySelector(".chaos_side_list").remove(),"favourites"===this.category){for(;this.messageClass.messagesElement.firstChild;)this.messageClass.messagesElement.removeChild(this.messageClass.messagesElement.firstChild);return this.messageClass.messages.clear(),this.request.send("load"),this.parentElement.append(this.listElement),void(this.category="")}this.parentElement.append(this.listElement),this.messageClass.closeSelectMessage()}showCategoryItems(e){const s=a.createSideCategoryList();for(const t of e.data){const i=this.categoryItems[e.category].handler(t.name,this.request.server);s.append(i),i.querySelector(".chaos_side_open_select").addEventListener("click",()=>this.request.send("select",t.messageId))}this.parentElement.append(s)}showFavouritesDescription(e){const s=a.createSideCategoryList(),t=a.createFavouritesDescription(e.length,e[e.length-1].date,e[0].date);s.append(t),this.parentElement.append(s)}}class n{constructor(e,s,t){this.parentElement=e,this.formElement=this.parentElement.querySelector(".chaos_form"),this.mainElement=this.parentElement.querySelector(".chaos_main"),this.clipElement=this.formElement.querySelector(".chaos_form_clip"),this.inputElement=this.formElement.querySelector(".chaos_form_input"),this.buttonElement=this.formElement.querySelector(".chaos_file_button"),this.dropplace=this.parentElement.querySelector(".chaos_dropplace"),this.geolocation=s,this.request=t,this.openForm=this.openForm.bind(this),this.closeForm=this.closeForm.bind(this),this.showDropPlace=this.showDropPlace.bind(this),this.hideDropPlace=this.hideDropPlace.bind(this),this.loadFile=this.loadFile.bind(this)}openForm(){for(;this.formElement.firstChild;)this.formElement.removeChild(this.formElement.firstChild);this.closeElement=a.getCloseForm(),this.addFormElement=a.getAddForm(),this.formElement.append(this.closeElement,this.addFormElement,this.clipElement),this.geolocation.coords&&this.formElement.append(this.geolocation.geoElement),this.inputFileElement=this.addFormElement.querySelector("input.chaos_file_hidden"),this.dropplace=a.createDropPlace(),this.mainElement.prepend(this.dropplace),this.closeElement.addEventListener("click",this.closeForm),this.mainElement.addEventListener("dragover",this.showDropPlace),this.dropplace.addEventListener("dragleave",this.hideDropPlace),this.dropplace.addEventListener("drop",this.loadFile),this.inputFileElement.addEventListener("change",this.loadFile)}closeForm(){this.closeElement.remove(),this.clipElement.classList.remove("chaos_form_clip_active"),this.addFormElement.replaceWith(this.inputElement)}showDropPlace(e){e.preventDefault(),this.dropplace.style.visibility="visible"}hideDropPlace(){this.dropplace.style.visibility="hidden"}loadFile(e){e.preventDefault();const s=this.inputFileElement.files[0]||e.dataTransfer.files[0],t=new FormData;t.append("file",s),t.append("geo",this.geolocation.coords),this.request.sendFile(t),this.hideDropPlace(),this.mainElement.removeEventListener("dragover",this.showDropPlace),this.closeForm(),this.geolocation.removeCoords()}}class r{constructor(e,s,t){this.formElement=e,this.inputElement=this.formElement.querySelector(".chaos_form_input"),this.clipElement=this.formElement.querySelector(".chaos_form_clip"),this.geolocation=s,this.request=t,this.openMedia=this.openMedia.bind(this),this.closeForm=this.closeForm.bind(this),this.startRecording=this.startRecording.bind(this),this.stopRecording=this.stopRecording.bind(this)}openMedia(e){const s={audio:!0};let t="аудио";if(e.target.classList.contains("chaos_add_video")?(s.video=!0,this.blobType="video/mp4",t="видео"):this.blobType="audio/wav",navigator.mediaDevices&&window.MediaRecorder){try{navigator.mediaDevices.getUserMedia(s).then(e=>{this.stream=e,this.recorder=new MediaRecorder(this.stream)}).catch(()=>this.showError())}catch(e){this.showError()}this.openMediaForm(t)}else this.showError()}openMediaForm(e){for(;this.formElement.firstChild;)this.formElement.removeChild(this.formElement.firstChild);this.closeElement=a.getCloseForm(),this.addMediaElement=a.getMediaForm(e),this.formElement.append(this.closeElement,this.addMediaElement,this.clipElement),this.geolocation.coords&&this.formElement.append(this.geolocation.geoElement),this.recordStart=this.addMediaElement.querySelector(".chaos_media_record"),this.recordStop=this.addMediaElement.querySelector(".chaos_media_stop"),this.statusRecord=this.addMediaElement.querySelector(".chaos_media_status"),this.recordStart.addEventListener("click",this.startRecording),this.recordStop.addEventListener("click",this.stopRecording),this.closeElement.addEventListener("click",this.closeForm)}closeForm(){this.closeElement.remove(),this.clipElement.classList.remove("chaos_form_clip_active"),this.addMediaElement.replaceWith(this.inputElement)}showError(){for(;this.formElement.firstChild;)this.formElement.removeChild(this.formElement.firstChild);this.closeElement=a.getCloseForm(),this.addMediaElement=a.errorMediaForm(),this.formElement.append(this.closeElement,this.addMediaElement,this.clipElement),this.closeElement.addEventListener("click",this.closeForm)}startRecording(){this.chunks=[],this.recorder.addEventListener("dataavailable",e=>{this.chunks.push(e.data)}),this.recorder.addEventListener("stop",()=>{this.loadFile()}),this.recorder.start(),this.showStatus()}stopRecording(){"inactive"!==this.recorder.state&&(clearInterval(this.timerInterval),this.statusRecord.innerText="Запись завершена. Отправка.",this.recorder.stop(),this.stream.getTracks().forEach(e=>e.stop()))}showStatus(){let e=0;this.statusRecord.innerText=`Идёт запись: ${e} сек.`,this.timerInterval=setInterval(()=>{e+=1,this.statusRecord.innerText=`Идёт запись: ${e} сек.`},1e3)}loadFile(){const e=new Blob(this.chunks,{type:this.blobType}),s=new FormData;s.append("file",e),s.append("geo",this.geolocation.coords),this.request.sendFile(s),this.closeForm(),this.geolocation.removeCoords()}}class l{constructor(e){this.formElement=e,this.coords="",this.geoElement="",this.attachGeo=this.attachGeo.bind(this),this.removeCoords=this.removeCoords.bind(this)}attachGeo(){this.promiseThroughAPI().then(e=>{this.addCoords(e)}).catch(()=>{this.addCoords()})}promiseThroughAPI(){return navigator.geolocation?new Promise((e,s)=>{navigator.geolocation.getCurrentPosition(s=>{e({latitude:s.coords.latitude,longitude:s.coords.longitude})},e=>{s(e)})}):new Promise((e,s)=>s(new Error("No Geolocation API")))}addCoords(e){let s="Координаты не определены";if(this.geoElement&&this.removeCoords(),e){const{latitude:t,longitude:i}=e;s=`${t.toFixed(6)}, ${i.toFixed(6)}`,this.coords=s}this.geoElement=a.createGeoElement(s),this.formElement.append(this.geoElement);this.geoElement.querySelector(".chaos_geo_close").addEventListener("click",this.removeCoords)}removeCoords(){this.coords="",this.geoElement&&this.geoElement.remove()}}class c{constructor(e,s){this.messageClass=e,this.request=s,this.pinMessage=this.pinMessage.bind(this),this.unpinMessage=this.unpinMessage.bind(this),this.markPinnedMessage=this.markPinnedMessage.bind(this),this.unmarkPinnedMessage=this.unmarkPinnedMessage.bind(this),this.showPinnedMessage=this.showPinnedMessage.bind(this),this.removePinnedMessage=this.removePinnedMessage.bind(this)}pinMessage(e){const s=this.messageClass.messages.get(e.target.closest(".chaos_messages_message"));s!==this.pinnedMessage&&(this.request.send("pin",s),this.messageClass.closeMessageTools(e))}unpinMessage(){this.request.send("unpin",this.pinnedMessage)}markPinnedMessage(e){this.unmarkPinnedMessage();const s=[...this.messageClass.messages.entries()].filter(s=>{let{1:t}=s;return t===e}).map(e=>{let[s]=e;return s}),t=a.getPinMark();s[0].querySelector(".chaos_message_header").prepend(t),t.addEventListener("click",this.unpinMessage)}unmarkPinnedMessage(){const e=this.messageClass.messagesElement.querySelector(".chaos_message_pin");e&&e.remove(),this.removePinnedMessage()}showPinnedMessage(e,s,t,i,o){this.removePinnedMessage(),this.pinnedMessage=s;const n=this.messageClass.buildMessageElement(e,s,t,i,o);this.pinnedMessageElement=a.getPinnedMessage(n.querySelector(".chaos_message_body")),this.messageClass.messagesElement.append(this.pinnedMessageElement);this.pinnedMessageElement.querySelector(".chaos_pinned_close").addEventListener("click",this.unpinMessage);this.pinnedMessageElement.querySelector(".chaos_pinned_select").addEventListener("click",()=>this.request.send("select",this.pinnedMessage))}removePinnedMessage(){this.messageClass.messagesElement.querySelector(".chaos_pinned")&&(this.pinnedMessageElement.remove(),this.pinnedMessage="")}}class d{constructor(e,s){this.messageClass=e,this.request=s,this.addToFavourites=this.addToFavourites.bind(this),this.removeFromFavourites=this.removeFromFavourites.bind(this),this.showFavouriteMark=this.showFavouriteMark.bind(this),this.removeFavouriteMark=this.removeFavouriteMark.bind(this)}addToFavourites(e){const s=this.messageClass.messages.get(e.target.closest(".chaos_messages_message"));e.target.closest(".chaos_messages_message").querySelector(".chaos_message_favourite")||(this.request.send("favourite",s),this.messageClass.closeMessageTools(e))}removeFromFavourites(e){const s=this.messageClass.messages.get(e.target.closest(".chaos_messages_message"));this.request.send("favouriteRemove",s)}showFavouriteMark(e){const s=[...this.messageClass.messages.entries()].filter(s=>{let{1:t}=s;return t===e}).map(e=>{let[s]=e;return s}),t=a.getFavouriteMark();s[0].querySelector(".chaos_message_header").prepend(t),t.addEventListener("click",this.removeFromFavourites)}removeFavouriteMark(e){[...this.messageClass.messages.entries()].filter(s=>{let{1:t}=s;return t===e}).map(e=>{let[s]=e;return s})[0].querySelector(".chaos_message_favourite").remove()}}new class{constructor(e,s){this.server=s,this.parentElement=e,this.formElement=this.parentElement.querySelector(".chaos_form"),this.inputElement=this.formElement.querySelector(".chaos_form_input"),this.clipElement=this.formElement.querySelector(".chaos_form_clip"),this.addFormElement=this.formElement.querySelector(".chaos_add_container"),this.addFileElement=this.addFormElement.querySelector(".chaos_add_files"),this.addAudioElement=this.addFormElement.querySelector(".chaos_add_audio"),this.addVideoElement=this.addFormElement.querySelector(".chaos_add_video"),this.addGeoElement=this.addFormElement.querySelector(".chaos_add_geo"),this.messagesElement=this.parentElement.querySelector(".chaos_messages"),this.messages=new Map,this.request=new i(this.server),this.sidePanel=new o(this.parentElement.querySelector(".chaos_side"),this,this.request),this.geolocation=new l(this.formElement),this.fileLoader=new n(this.parentElement,this.geolocation,this.request),this.mediaLoader=new r(this.formElement,this.geolocation,this.request),this.pin=new c(this,this.request),this.favourites=new d(this,this.request),this.submitForm=this.submitForm.bind(this),this.showAddForm=this.showAddForm.bind(this),this.removeError=this.removeError.bind(this),this.connectionError=this.connectionError.bind(this),this.addMessage=this.addMessage.bind(this),this.addFile=this.addFile.bind(this),this.renderMessages=this.renderMessages.bind(this),this.lazyLoad=this.lazyLoad.bind(this),this.showSelectMessage=this.showSelectMessage.bind(this),this.closeSelectMessage=this.closeSelectMessage.bind(this),this.showMessageDot=this.showMessageDot.bind(this),this.removeMessageDot=this.removeMessageDot.bind(this),this.showMessageTools=this.showMessageTools.bind(this),this.closeMessageTools=this.closeMessageTools.bind(this),this.deleteMessage=this.deleteMessage.bind(this),this.deleteMessageElement=this.deleteMessageElement.bind(this)}init(){this.request.callbacks={error:this.connectionError,load:this.renderMessages,message:this.addMessage,file:this.addFile,showMessage:this.showSelectMessage,delete:this.deleteMessageElement,favourite:this.favourites.showFavouriteMark,favouriteRemove:this.favourites.removeFavouriteMark,sideLoad:this.sidePanel.render,sideCategory:this.sidePanel.showCategoryItems,sideFavourites:this.sidePanel.showFavouritesDescription,pin:this.pin.markPinnedMessage,pinMessage:this.pin.showPinnedMessage,unpin:this.pin.unmarkPinnedMessage},this.request.init(),this.messagesElement.addEventListener("scroll",this.lazyLoad),this.formElement.addEventListener("submit",this.submitForm),this.clipElement.addEventListener("click",this.showAddForm),this.addFileElement.addEventListener("click",this.fileLoader.openForm),this.addAudioElement.addEventListener("click",this.mediaLoader.openMedia),this.addVideoElement.addEventListener("click",this.mediaLoader.openMedia),this.addGeoElement.addEventListener("click",this.geolocation.attachGeo)}buildMessageElement(e,s,t,i,o){if(-1!==[...this.messages.values()].indexOf(s)){return[...this.messages.entries()].filter(e=>{let{1:t}=e;return t===s}).map(e=>{let[s]=e;return s})[0]}let n="";switch(e){case"text":n=a.createMessageElement(t,i,o);break;case"image":n=a.createImageElement(this.server,t,i,o);break;case"video":n=a.createVideoElement(this.server,t,i,o);break;case"audio":n=a.createAudioElement(this.server,t,i,o);break;case"file":n=a.createFileElement(this.server,t,i,o)}return this.messages.set(n,s),n.addEventListener("mouseenter",this.showMessageDot),n.addEventListener("mouseleave",this.removeMessageDot),n}renderMessages(e,s,t){for(const t of e){const e=this.buildMessageElement(t.type,t.id,t.message,t.geo,t.date);-1!==s.indexOf(t.id)&&this.favourites.showFavouriteMark(t.id),t.pinned&&this.pin.markPinnedMessage(t.id),this.messagesElement.prepend(e),this.databasePosition||this.scrollBottom(e)}this.databasePosition=t,this.databasePosition>0&&(this.upperMessageElement=this.messagesElement.querySelector(".chaos_messages_message:nth-child(3)"))}lazyLoad(){this.databasePosition<=0||this.upperMessageElement&&this.upperMessageElement.getBoundingClientRect().bottom>0&&(this.upperMessageElement="",this.request.send("load",this.databasePosition))}showSelectMessage(e){const s=this.buildMessageElement(e.type,e.id,e.message,e.geo,e.date),t=a.createSelectContainer(e.date),i=t.querySelector(".chaos_select_close");t.append(s),this.parentElement.querySelector(".chaos_messages").replaceWith(t),i.addEventListener("click",this.closeSelectMessage)}closeSelectMessage(){this.parentElement.querySelector(".chaos_select_container")&&(this.parentElement.querySelector(".chaos_select_container").replaceWith(this.messagesElement),this.messagesElement.scrollTop=this.messagesElement.scrollHeight-this.messagesElement.getBoundingClientRect().height)}showAddForm(){this.addFormElement.classList.toggle("chaos_add_container_visible"),this.clipElement.classList.toggle("chaos_form_clip_active")}submitForm(e){e.preventDefault();this.inputElement.value?this.request.send("message",{text:this.inputElement.value,geo:this.geolocation.coords}):this.showError()}addMessage(e,s,t,i){const a=this.buildMessageElement("text",e,s,t,i);a.classList.add("chaos_messages_message_animation"),a.addEventListener("animationend",()=>{a.classList.remove("chaos_messages_message_animation")}),this.messagesElement.append(a),this.scrollBottom(a),this.inputElement.value="",this.geolocation.removeCoords()}addFile(e,s,t,i){const a=this.buildMessageElement(e,s,t,i);a.classList.add("chaos_messages_message_animation"),this.messagesElement.append(a),this.scrollBottom(a)}showMessageDot(e){const s=e.target.querySelector(".chaos_message_tools");s.classList.add("chaos_message_tools_show"),s.addEventListener("click",this.showMessageTools)}removeMessageDot(e){const s=e.target.querySelector(".chaos_message_tools");s.classList.remove("chaos_message_tools_show"),s.classList.remove("chaos_message_tools_active");const t=e.target.querySelector(".chaos_message_tools_container");t&&(s.removeEventListener("click",this.closeMessageTools),t.remove())}showMessageTools(e){const s=e.target;s.classList.add("chaos_message_tools_active"),s.removeEventListener("click",this.showMessageTools),s.addEventListener("click",this.closeMessageTools);const t=a.createToolsElements();s.after(t);const i=t.querySelector(".chaos_message_tools_delete"),o=t.querySelector(".chaos_message_tools_pin"),n=t.querySelector(".chaos_message_tools_favourite");i.addEventListener("click",this.deleteMessage),o.addEventListener("click",this.pin.pinMessage),n.addEventListener("click",this.favourites.addToFavourites)}closeMessageTools(e){const s=e.target,t=s.closest(".chaos_message_header").querySelector(".chaos_message_tools_container");t&&t.remove(),s.classList.toggle("chaos_message_tools_active"),s.removeEventListener("click",this.closeMessageTools),s.addEventListener("click",this.showMessageTools)}deleteMessage(e){const s=this.messages.get(e.target.closest(".chaos_messages_message"));this.request.send("delete",s)}deleteMessageElement(e){this.parentElement.querySelector(".chaos_select_container")&&(this.closeSelectMessage(),this.sidePanel.closeCategory()),this.pin.pinnedMessage===e&&this.pin.removePinnedMessage();[...this.messages.entries()].filter(s=>{let{1:t}=s;return t===e}).map(e=>{let[s]=e;return s}).forEach(e=>{this.messages.delete(e),e.remove()})}scrollBottom(e){let s=e.querySelectorAll(".chaos_message_body video, .chaos_message_body audio");[...s].forEach(e=>{e.addEventListener("loadeddata",()=>{this.messagesElement.scrollTop=this.messagesElement.scrollHeight-this.messagesElement.getBoundingClientRect().height})}),s=e.querySelectorAll(".chaos_message_body img"),[...s].forEach(e=>{e.addEventListener("load",()=>{this.messagesElement.scrollTop=this.messagesElement.scrollHeight-this.messagesElement.getBoundingClientRect().height})}),this.messagesElement.scrollTop=this.messagesElement.scrollHeight-this.messagesElement.getBoundingClientRect().height}showError(){this.inputElement.classList.add("chaos_form_invalid"),this.inputElement.addEventListener("keydown",this.removeError)}removeError(){this.inputElement.classList.remove("chaos_form_invalid"),this.inputElement.removeEventListener("keydown",this.removeError)}connectionError(){const e=a.createErrorConnectionElement();this.parentElement.querySelector(".chaos_container").append(e)}}(document.querySelector(".chaos_organizer"),"https://https://ahj-diploma-server.vercel.app").init()}]);